<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ - Student ID: <%= studentId %></title>
    <link rel="stylesheet" href="/style.css">
</head>
<body>
    <div class="wrapper">
        <header class="header">
            <div class="container">
                <h1 class="logo">–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞</h1>
                <div class="student-badge">Student ID: <span><%= studentId %></span></div>
            </div>
        </header>

        <main class="main">
            <div class="container">
                <!-- –ö–Ω–æ–ø–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ -->
                <section class="sync-section">
                    <div class="sync-card">
                        <div class="sync-header">
                            <h2>–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö</h2>
                            <button id="syncBtn" class="btn-sync">
                                <span class="sync-icon">üîÑ</span>
                                <span class="sync-text">–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å</span>
                            </button>
                        </div>
                        <div id="syncStatus" class="sync-status" style="display: none;">
                            <div class="sync-message"></div>
                            <div class="sync-progress"></div>
                        </div>
                    </div>
                </section>

                <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ—Ü–µ–Ω–∫–∏ -->
                <section id="resultsSection" class="results-card" <% if (!results) { %>style="display: none;"<% } %>>
                    <% if (results) { %>
                    <div class="results-header">
                        <h2>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ—Ü–µ–Ω–∫–∏</h2>
                        <div id="gradeBadge" class="grade-badge grade-<%= results.result %>">
                            <span id="gradeNumber" class="grade-number"><%= results.result %></span>
                            <span class="grade-label">–û—Ü–µ–Ω–∫–∞</span>
                        </div>
                    </div>
                    <div class="results-info">
                        <div class="info-item">
                            <span class="info-label">–ü–æ—Å–ª–µ–¥–Ω—è—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è:</span>
                            <span id="lastSyncAt" class="info-value"><%= results.lastSyncAt || '–ù–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞' %></span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">–°–æ–æ–±—â–µ–Ω–∏–µ:</span>
                            <span id="lastSyncMessage" class="info-value"><%= results.lastSyncMessage || '-' %></span>
                        </div>
                    </div>
                    <% } %>
                </section>

                <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
                <section class="stats-section">
                    <h2 class="section-title">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
                    <div class="stats-grid">
                        <div class="stat-box primary">
                            <div class="stat-icon">üì¶</div>
                            <div class="stat-content">
                                <div id="totalSpares" class="stat-value"><%= stats.total %></div>
                                <div class="stat-label">–í—Å–µ–≥–æ –¥–µ—Ç–∞–ª–µ–π</div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è -->
                <section class="details-section">
                    <div class="details-grid">
                        <div class="detail-card">
                            <h3 class="detail-title">–ü–æ —Å—Ç–∞—Ç—É—Å–∞–º</h3>
                            <div class="detail-list">
                                <% Object.entries(stats.byStatus).forEach(([status, count]) => { %>
                                    <div class="detail-item">
                                        <span class="detail-name"><%= status %></span>
                                        <span class="detail-count"><%= count %></span>
                                    </div>
                                <% }); %>
                            </div>
                        </div>
                        <div class="detail-card">
                            <h3 class="detail-title">–ü–æ —Ç–∏–ø–∞–º</h3>
                            <div class="detail-list">
                                <% Object.entries(stats.byType).forEach(([type, count]) => { %>
                                    <div class="detail-item">
                                        <span class="detail-name"><%= type %></span>
                                        <span class="detail-count"><%= count %></span>
                                    </div>
                                <% }); %>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- –¢–∞–±–ª–∏—Ü–∞ –¥–µ—Ç–∞–ª–µ–π -->
                <section class="table-section">
                    <div class="section-header">
                        <h2 class="section-title">–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –¥–µ—Ç–∞–ª–µ–π</h2>
                        <a href="/spares" class="btn-primary">–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ</a>
                    </div>
                    <div class="table-wrapper">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>–ö–æ–¥</th>
                                    <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                                    <th>–¢–∏–ø</th>
                                    <th>–°—Ç–∞—Ç—É—Å</th>
                                    <th>–¶–µ–Ω–∞</th>
                                    <th>–ö–æ–ª-–≤–æ</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% if (spares.length > 0) { %>
                                    <% spares.forEach(spare => { %>
                                        <tr>
                                            <td><code><%= spare.spare_code %></code></td>
                                            <td><%= spare.spare_name %></td>
                                            <td><span class="badge"><%= spare.spare_type %></span></td>
                                            <td><span class="status-badge status-<%= spare.spare_status.toLowerCase() %>"><%= spare.spare_status %></span></td>
                                            <td><%= spare.price || '-' %></td>
                                            <td><%= spare.quantity || '-' %></td>
                                        </tr>
                                    <% }); %>
                                <% } else { %>
                                    <tr>
                                        <td colspan="6" class="empty-state">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td>
                                    </tr>
                                <% } %>
                            </tbody>
                        </table>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <script>
        const syncBtn = document.getElementById('syncBtn');
        const syncStatus = document.getElementById('syncStatus');
        const syncMessage = syncStatus.querySelector('.sync-message');
        const syncProgress = syncStatus.querySelector('.sync-progress');

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –æ—Ü–µ–Ω–∫–∏
        function updateResults(results) {
            const resultsSection = document.getElementById('resultsSection');
            if (!resultsSection) return;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–µ–∫—Ü–∏—é, –µ—Å–ª–∏ –æ–Ω–∞ –±—ã–ª–∞ —Å–∫—Ä—ã—Ç–∞
            resultsSection.style.display = 'block';
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ü–µ–Ω–∫—É
            const gradeNumber = document.getElementById('gradeNumber');
            const gradeBadge = document.getElementById('gradeBadge');
            if (gradeNumber && results.result) {
                gradeNumber.textContent = results.result;
                // –û–±–Ω–æ–≤–ª—è–µ–º –∫–ª–∞—Å—Å –¥–ª—è —Ü–≤–µ—Ç–∞
                gradeBadge.className = `grade-badge grade-${results.result}`;
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
            const lastSyncAt = document.getElementById('lastSyncAt');
            if (lastSyncAt && results.lastSyncAt) {
                lastSyncAt.textContent = results.lastSyncAt;
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
            const lastSyncMessage = document.getElementById('lastSyncMessage');
            if (lastSyncMessage && results.lastSyncMessage) {
                lastSyncMessage.textContent = results.lastSyncMessage;
            }
        }

        syncBtn.addEventListener('click', async function() {
            // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
            syncBtn.disabled = true;
            syncBtn.classList.add('syncing');
            syncStatus.style.display = 'block';
            syncMessage.textContent = '–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–ø—É—â–µ–Ω–∞...';
            syncProgress.textContent = '';

            try {
                const response = await fetch('/api/sync', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞
                if (!response.ok) {
                    const contentType = response.headers.get('content-type');
                    let errorMessage = `–û—à–∏–±–∫–∞ ${response.status}: ${response.statusText}`;
                    
                    // –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—Å—Ç –æ—à–∏–±–∫–∏
                    if (contentType && contentType.includes('application/json')) {
                        try {
                            const errorData = await response.json();
                            errorMessage = errorData.message || errorData.error || errorMessage;
                        } catch (e) {
                            // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å JSON, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ–∫—Å—Ç
                            const text = await response.text();
                            errorMessage = text || errorMessage;
                        }
                    } else {
                        // –ï—Å–ª–∏ –æ—Ç–≤–µ—Ç –Ω–µ JSON, —á–∏—Ç–∞–µ–º –∫–∞–∫ —Ç–µ–∫—Å—Ç
                        const text = await response.text();
                        if (text && !text.startsWith('<!DOCTYPE')) {
                            errorMessage = text;
                        }
                    }
                    
                    throw new Error(errorMessage);
                }

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –æ—Ç–≤–µ—Ç –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ JSON
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    throw new Error('–°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –Ω–µ JSON –æ—Ç–≤–µ—Ç: ' + text.substring(0, 100));
                }

                const data = await response.json();

                if (data.success) {
                    syncMessage.textContent = '‚úì ' + data.message;
                    syncProgress.textContent = `CMS ‚Üí –ë–î: ${data.cmsToDb.synced} –∑–∞–ø–∏—Å–µ–π | –ë–î ‚Üí Report API: ${data.dbToReport.synced} –∑–∞–ø–∏—Å–µ–π`;
                    syncStatus.classList.add('success');
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ—Ü–µ–Ω–∫–∏, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
                    if (data.results) {
                        updateResults(data.results);
                    }
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                    if (data.dbToReport && data.dbToReport.synced !== undefined) {
                        const totalElement = document.getElementById('totalSpares');
                        if (totalElement) {
                            totalElement.textContent = data.dbToReport.synced;
                        }
                    }
                    
                    // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã, —á—Ç–æ–±—ã –ø–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                    setTimeout(() => {
                        window.location.reload();
                    }, 3000);
                } else {
                    syncMessage.textContent = '‚úó –û—à–∏–±–∫–∞: ' + data.message;
                    syncStatus.classList.add('error');
                }
            } catch (error) {
                console.error('Sync error:', error);
                syncMessage.textContent = '‚úó –û—à–∏–±–∫–∞: ' + error.message;
                syncStatus.classList.add('error');
            } finally {
                syncBtn.disabled = false;
                syncBtn.classList.remove('syncing');
            }
        });
    </script>
</body>
</html>
